<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WireGuard GOST WebUI</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet">
        <!-- Bootstrap JavaScript and dependencies -->
    <!-- Make sure this matches the Bootstrap CSS version -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.bundle.min.js"></script>
</head>
<body>

<div class="d-flex" id="wrapper">
    <!-- Sidebar -->
    <div class="bg-light border-right" id="sidebar-wrapper">
        <img src="static/images/logo.jpg" alt="Sidebar Image" class="img-fluid">
        <div id="alert-placeholder" style="display: none;"></div>

        <div class="list-group">
            <a href="#" class="list-group-item list-group-item-action bg-light" id="wireguard-config">WireGuard</a>
            <a href="#" class="list-group-item list-group-item-action bg-light" id="gost-config">GOST</a>
        </div>

    </div>


    <!-- /#sidebar-wrapper -->

    <!-- Page Content -->
    <div id="page-content-wrapper">
        <div class="container-fluid">
            <!-- Dynamic content will be loaded here -->
        </div>
    </div>
    <!-- /#page-content-wrapper -->
</div>
<!-- /#wrapper -->






<script>
$(document).ready(function() {
    // Code for toggling GOST configuration management
    $("#gost-config").click(function(e) {
        e.preventDefault();
        $(".container-fluid").html('<h1 class="mt-4">GOST Configuration Management</h1><p>Manage your GOST configurations here.</p>');
        // Additional logic to load GOST Configuration Management UI can be added here
    });

    // Code for toggling WireGuard configuration management
    $("#wireguard-config").click(function(e) {
        e.preventDefault();
        loadWireguardConfigs();
    });

// JavaScript to handle the add interface form submission
document.getElementById('addWireguardForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const wgConfig = document.getElementById('wgConfigTextarea').value;
    
    // Submit the configuration to the Flask API
    fetch('/api/wireguard/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `wg_config=${encodeURIComponent(wgConfig)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            console.log(data.message);
            // Close the modal
            $('#addWireguardModal').modal('hide');
            // Optionally, clear the textarea
            document.getElementById('wgConfigTextarea').value = '';
            // Reload the configurations to show the new interface
            loadWireguardConfigs();
        } else {
            console.error('Error:', data.message);
            // Show an error message in the modal
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
});

});

// Function to fetch and display WireGuard configurations with their status
function loadWireguardConfigs() {
    Promise.all([
        fetch('/api/wireguard/interfaces').then(response => response.json()),
        fetch('/api/wireguard/get_active_interfaces').then(response => response.json())
    ])
    .then(([allInterfaces, activeInterfaces]) => {
        let tableHtml = `<h1 class="mt-4">WireGuard Configuration Management</h1>        <div><!-- Add Interface Button -->
<button class="btn btn-success" data-toggle="modal" data-target="#addWireguardModal">Add WireGuard Interface</button></div>


                        <table class="table">
                            <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Interface</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>`;

        allInterfaces.data.forEach((interface, index) => {
            const isActive = activeInterfaces.data.includes(interface);
            const status = isActive ? 'Up' : 'Down';
            const statusClass = isActive ? 'text-success' : 'text-secondary';
            
            tableHtml += `<tr>
                            <th scope="row">${index + 1}</th>
                            <td>${interface}</td>
                            <td class="${statusClass}">${status}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="startInterface('${interface}')">Start</button>
                                <button class="btn btn-secondary btn-sm" onclick="stopInterface('${interface}')">Stop</button>
                                <button class="btn btn-info btn-sm" onclick="editInterface('${interface}')">Edit</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteInterface('${interface}', this)">Delete</button>
                            </td>
                        </tr>`;
        });

        tableHtml += `</tbody></table>`;
        $(".container-fluid").html(tableHtml);
    })
    .catch(error => {
        console.error('Error fetching WireGuard configurations:', error);
    });
}

// Implement the startInterface, stopInterface, and deleteInterface functions as needed

function deleteInterface(interfaceName, buttonElement) {
    if (interfaceName) {
        // Using fetch to make the GET request
        fetch(`/api/wireguard/remove_config?interface=${interfaceName}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok.');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // Display Bootstrap success alert
                    displayAlert('success', 'Interface deleted successfully.');

                    // Remove the table row for this interface
                    if (buttonElement) {
                        const row = buttonElement.closest('tr');
                        row.remove();
                    }
                } else {
                    // Display Bootstrap error alert
                    displayAlert('danger', 'Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Display Bootstrap error alert
                displayAlert('danger', 'An error occurred while trying to delete the interface.');
            });
    }
}

function displayAlert(type, message) {
    const alertPlaceholder = document.getElementById('alert-placeholder');
    const alert = `<div class="alert alert-${type}" role="alert">${message}</div>`;
    alertPlaceholder.innerHTML = alert;
    alertPlaceholder.style.display = 'block';
}

// Function to stop an interface
function stopInterface(interfaceName) {
    fetch(`/api/wireguard/stop_config?interface=${encodeURIComponent(interfaceName)}`, {
        method: 'GET'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === "success" || data.status === "warning") {
            console.log(data.message);
            // Update the UI to reflect that the interface has been stopped
            loadWireguardConfigs();  // Reload the interface list to reflect the change
        } else {
            console.error(data.message);
            // Handle the error. Show an error message to the user, etc.
        }
    })
    .catch(error => {
        console.error('Error stopping the interface:', error);
        // Handle network errors or other unforeseen errors
    });
}

// Function to start an interface
function startInterface(interfaceName) {
    fetch(`/api/wireguard/start_config?interface=${encodeURIComponent(interfaceName)}`, {
        method: 'GET'  // Though it's typically better practice to use 'POST' for such operations
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === "success") {
            console.log(data.message);
            // Update the UI to reflect that the interface has been started
            loadWireguardConfigs();  // Reload the interface list to reflect the change
        } else {
            console.error(data.message);
            // Handle the error. Show an error message to the user, etc.
        }
    })
    .catch(error => {
        console.error('Error starting the interface:', error);
        // Handle network errors or other unforeseen errors
    });
}


 // Function to open edit interface modal and fetch configuration
 function editInterface(interfaceName) {
        fetch(`/api/wireguard/get_config?interface=${encodeURIComponent(interfaceName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    // Set the hidden field value to the interface name
                    $('#editInterfaceName').val(interfaceName);
                    // Set the textarea value to the current configuration
                    $('#editConfigTextArea').val(data.message);
                    // Show the edit configuration modal
                    $('#editConfigurationModal').modal('show');
                } else {
                    console.error('Error fetching configuration:', data.message);
                    // Handle error
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

// Handle form submission for editing the configuration
    $('#editConfigForm').submit(function(e) {
        e.preventDefault();
        const interfaceName = $('#editInterfaceName').val();
        const newConfig = $('#editConfigTextArea').val();

        // Submit the updated configuration
        fetch('/api/wireguard/modify_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `interface=${encodeURIComponent(interfaceName)}&config=${encodeURIComponent(newConfig)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                console.log(data.message);
                // Hide the modal
                $('#editConfigurationModal').modal('hide');
                // Optionally, clear the textarea
                $('#editConfigTextArea').val('');
                // Reload the configurations to show the updated interface
                loadWireguardConfigs();
            } else {
                console.error('Error:', data.message);
                // Show an error message
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });



</script>

<!-- Add WireGuard Configuration Modal -->
<div class="modal fade" id="addWireguardModal" tabindex="-1" role="dialog" aria-labelledby="addWireguardModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addWireguardModalLabel">Add WireGuard Interface</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addWireguardForm">
                    <div class="form-group">
                        <label for="wgConfigTextarea">Configuration</label>
                        <textarea class="form-control" id="wgConfigTextarea" rows="10" placeholder="Enter WireGuard configuration here"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Interface</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Configuration Modal -->
<div class="modal fade" id="editConfigurationModal" tabindex="-1" role="dialog" aria-labelledby="editConfigurationModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editConfigurationModalLabel">Edit Configuration</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editConfigForm">
                    <div class="form-group">
                        <label for="editConfigTextArea">Configuration</label>
                        <textarea class="form-control" id="editConfigTextArea" rows="10"></textarea>
                    </div>
                    <input type="hidden" id="editInterfaceName" value="">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>


</body>
</html>
